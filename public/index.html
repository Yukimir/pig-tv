<html>

<head>
    <title>母猪TV-放飞自我的舞台</title>
    <link rel="stylesheet" href="player.css" type="text/css" />
    <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
    <style>
        html,
        body {
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .background {
            position:fixed;
            height:100%;
            width:100%;
            /*background: url('./background.png');*/
            background-repeat: no-repeat;
            opacity: 0.2;
            z-index: -100;
        }

        .main-container {
            height: 70%;
            display: flex;
            justify-content: center;
        }

        .sub-container {
            height: 30%;
            display: flex;
            flex-wrap: nowrap;
        }

        .video-container {
            position: relative;
            text-align: center;
            margin-left: 10px;
            margin-right: 10px;
        }

        .video-container .hint {
            position: absolute;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
            z-index: -1;
            font-size: 30px;
        }

        .container {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .live-container {
            width: 80%;
        }

        .dj-container {
            width: 20%;
            display: flex;
            position: relative;
            flex-direction: column;
            overflow: auto;
        }

        .stream-close {
            position: absolute;
            right: 0;
            top: 10px;
        }

        .alipay-box {
            text-align: center;
            max-width: 100%;
        }

        .card {
            box-shadow: 0px 2px 6px 1px #88888888;
            margin-bottom: 20px;
            margin-top: 10px;
            margin-left: 10px;
            margin-right: 5px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
        }

        .main {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .navbar {
            height: 47px;
            padding-left: 30px;
            padding-right: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e5e5;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .navbar-background {
            height: 47px;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            /*background: url('./background.png');*/
            background-repeat: no-repeat;
            filter: blur(4px);
            z-index: -1;
            opacity: 0.2;
        }

        .navbar div {
            display: flex;
            align-items: center;
        }

        .navbar * {
            margin-left: 10px;
            margin-right: 10px;
        }

        img {
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>

<body>
    <script src="https://cdn.bootcss.com/flv.js/1.3.3/flv.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/player.js"></script>
    <div class="background"></div>
    <div class="main">
        <div class="navbar">

            <div>
                <img src="favicon.ico" style="height:40px;width:40px;" />
                <p>母猪TV-放飞自我的舞台</p>
            </div>
            <div>
                <p>登陆</p>
            </div>
        </div>
        <div class="navbar-background"></div>
        <div class="container">
            <div class="dj-container">
                <div class="info card">
                    <p>请不要直播NSFW内容。</p>
                    <p>NSFW包括但不限于 色情、残暴内容等。</p>
                    <br>
                    <p id="pigs-count"></p>
                </div>
                <div class="dj card">
                    <p>DJ列表（点击DJ名切换DJ）</p>
                    <div id="dj-list"></div>
                    <button onclick="closeStream()">只听DJ</button>
                    <button onclick="closeDJ()" id="muteDJ">不听DJ</button>
                    <audio id="audioElement"></audio>
                </div>
                <div class="alipay-box card">
                    <p>五月赞助名单</p>
                    <p>感谢残佬的233元</p>
                    <p>感谢喵的88.88元</p>
                    <p>感谢yukilo的12.45元</p>
                    <p>感谢钟佬的66.66元</p>
                    <img src="./alipay.png" />
                    <p>我很可爱 请给我钱</p>
                </div>
            </div>
            <div class="live-container">
                <div class="main-container">
                    <div class="video-container" id="video-container0">
                        <p class="hint">台上还没有人，快上台~</p>
                    </div>

                </div>
                <div class="sub-container">
                    <div class="video-container" id="video-container1" onclick="switchStream(1)"></div>
                    <div class="video-container" id="video-container2" onclick="switchStream(2)"></div>
                    <div class="video-container" id="video-container3" onclick="switchStream(3)"></div>
                </div>
            </div>
        </div>
    </div>




    <script>
        var host = 'live.aigis.me'
        let liveStreams = [];
        let djStreams = [];
        let players = [];
        let streamClosed = false;
        let usingDJ;
        let pigsCount = 0;
        // CreatePlayer
        for (let i = 0; i < 4; i++) {
            const e = document.getElementById(`video-container${i}`);
            players.push(new Player(e, i));
        }
        if (flvjs.isSupported()) {
            // Stream
            function offStream(i) {
                if (liveStreams[i]) {
                    removeStream(liveStreams[i].id);
                }
            }
            function closeStream() {
                closeStream = true;
                for (let i = 0; i < 4; i++) {
                    players[i].changeStream();
                }
            }
            function switchStream(i) {
                if (!liveStreams[0]) return;
                if (!liveStreams[i]) return;
                const mainStreams = liveStreams[0];
                const subStreams = liveStreams[i];
                liveStreams[0] = subStreams;
                liveStreams[i] = mainStreams;
                loadStreamsByList();
            }
            function addStream(stream) {
                liveStreams.push(stream);
                loadStreamsByList();
            }
            function removeStream(id) {
                let index = liveStreams.findIndex((v) => {
                    return v.id === id;
                });
                if (index === -1) return;
                liveStreams.splice(index, 1);
                loadStreamsByList();
            }
            function loadStreamsByList(list) {
                if (streamClosed) return;
                if (list) liveStreams = list;
                for (let i = 0; i < 4; i++) {
                    players[i].changeStream(liveStreams[i]);
                    if (i !== 0) players.muted = true;
                }
            }
            // DJ
            function closeDJ() {
                if (usingDJ.flvPlayer === undefined) return;
                document.getElementById('muteDJ').innerHTML = usingDJ.flvPlayer.muted ? '不听DJ' : '要听DJ';
                usingDJ.flvPlayer.muted = !usingDJ.flvPlayer.muted;
            }
            function genDjList() {
                const djListElement = document.getElementById('dj-list');
                djListElement.innerHTML = '';
                for (let i = 0; i < djStreams.length; i++) {
                    const stream = djStreams[i];
                    const spanElement = document.createElement('p');
                    const func = () => {
                        return () => {
                            let s = stream;
                            switchDJ(s);
                        }
                    }
                    spanElement.innerHTML = stream.StreamPath.slice(9);
                    spanElement.addEventListener('click', func());
                    if (stream === usingDJ) {
                        spanElement.style = 'color:red';
                    }
                    djListElement.appendChild(spanElement);
                }
            }
            function switchDJ(stream) {
                if (stream === usingDJ) return;
                if (usingDJ === undefined) return;
                usingDJ.flvPlayer.destroy();
                usingDJ.flvPlayer = undefined;
                usingDJ = stream;
                loadDjStreamByList();
            }

            function loadDjStreamByList(djList) {
                genDjList();
                const audioElement = document.getElementById('audioElement');
                if (djList) djStreams = djList;
                if (usingDJ === undefined) usingDJ = djStreams[0];
                let stream = usingDJ;
                if (!stream) return;
                if (stream.flvPlayer) return;
                let flvPlayer = flvjs.createPlayer({
                    type: 'flv',
                    isLive: true,
                    cors: true,
                    url: `ws://${host}:8000${stream.StreamPath}.flv`,
                    hasVideo: false
                })
                flvPlayer.attachMediaElement(audioElement);
                flvPlayer.load();
                flvPlayer.play();
                if (liveStreams[0] && liveStreams[0].flvPlayer) liveStreams[0].flvPlayer.muted = true;
                stream.flvPlayer = flvPlayer;

                //刷新DJ列表
                genDjList();
            }
            function removeDjStream(id) {
                let i = djStreams.findIndex((v) => {
                    return v.id === id;
                });
                if (i === -1) return;
                let stream = djStreams[i];
                if (stream.flvPlayer) {
                    djStreams[i].flvPlayer.pause();
                    djStreams[i].flvPlayer.destroy();
                    djStreams[i].flvPlayer = undefined;
                    if (djStreams[i] === usingDJ) usingDJ = undefined;
                    djStreams.splice(i, 1);
                    loadDjStreamByList();
                } else {
                    djStreams.splice(i, 1);
                    loadDjStreamByList();
                }
                if (djStreams.length === 0 && liveStreams[0]) liveStreams[0].flvPlayer.muted = false;
            }

            // WebSocket
            var socket = io();
            socket.on('liveStreams-list', (liveList, djList) => {
                loadStreamsByList(liveList);
                loadDjStreamByList(djList);
            })
            socket.on('post-publish', (stream) => {
                addStream(stream);
            })
            socket.on('done-publish', (id) => {
                removeStream(id);
                removeDjStream(id);
            })
            socket.on('dj-post-publish', (stream) => {
                djStreams.push(stream);
                loadDjStreamByList();
            });
            socket.on('update-pig', (pigs) => {
                pigsCount = pigs;
                document.getElementById('pigs-count').innerHTML = `当前有${pigsCount}只母猪正在围观`;
            })
            socket.emit('request-liveStreams');
        }
    </script>
</body>

</html>