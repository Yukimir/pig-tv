<html>

<head>
    <title>母猪TV-放飞自我的舞台</title>
    <style>
        html {
            overflow: hidden;
        }

        .main-container {
            height: 70%;
            display: flex;
            justify-content: center;
        }

        .sub-container {
            height: 30%;
            display: flex;
            flex-wrap: nowrap;
        }

        video {
            height: 100%;
            max-width: 100%;
        }

        .video-container {
            position: relative;
            text-align: center;
            margin-left: 10px;
            margin-right: 10px;
        }

        .container {
            display: flex;
        }

        .live-container {
            width: 80%;
        }

        .dj-container {
            width: 20%;
        }

        span {
            top: 10px;
            position: absolute;
            background: white;
            left: 10px;
        }

        .stream-close {
            position: absolute;
            right: 0;
            top: 10px;
            display: none;
        }
    </style>
</head>

<body>
    <script src="https://cdn.bootcss.com/flv.js/1.3.3/flv.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <div class="container">
        <div class="dj-container">
            <p>DJ列表</p>
            <br>
            <div id="dj-list"></div>
            <button onclick="closeStream()">只听DJ</button>
            <audio id="audioElement"></audio>
            <div style="text-align: center">
                <img src="./alipay.png"/>
                <p>我很可爱 请给我钱</p>
            </div>
        </div>
        <div class="live-container">
            <div class="main-container">
                <div class="video-container">
                    <video id="videoElement0"></video>
                    <span id="spanElement0"></span>
                    <button class="stream-close" onclick="offStream(0)">关闭</button>
                </div>
            </div>
            <div style="background:gray" class="sub-container">
                <div class="video-container" onclick="switchStream(1)">
                    <video id="videoElement1"></video>
                    <span id="spanElement1"></span>
                    <button class="stream-close" onclick="offStream(1)">关闭</button>
                </div>
                <div class="video-container" onclick="switchStream(2)">
                    <video id="videoElement2"></video>
                    <span id="spanElement2"></span>
                    <button class="stream-close" onclick="offStream(2)">关闭</button>
                </div>
                <div class="video-container" onclick="switchStream(3)">
                    <video id="videoElement3"></video>
                    <span id="spanElement3"></span>
                    <button class="stream-close" onclick="offStream(3)">关闭</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        const titleList = ['史诗母猪', '传说母猪', '金母猪', '银母猪', '皇帝', '绿马甲']
        var host = 'live.aigis.me'
        let liveStreams = [];
        let djStreams = [];
        let streamClosed = false;
        if (flvjs.isSupported()) {
            function offStream(i) {
                if (liveStreams[i]) {
                    removeStream(liveStreams[i].id);
                }
            }
            function closeStream() {
                closeStream = true;
                for (let i = 0; i < 4; i++) {
                    const stream = liveStreams[i];
                    if (stream && stream.flvPlayer) {
                        stream.flvPlayer.pause();
                        stream.flvPlayer.destroy();
                        stream.flvPlayer.undefined;
                        stream.spanElement.innerHTML = '';
                    }
                }
            }
            function switchStream(i) {
                if (!liveStreams[0]) return;
                if (!liveStreams[i]) return;
                if (!liveStreams[i].flvPlayer) return;
                const mainStreams = liveStreams[0];
                const subStreams = liveStreams[i];
                liveStreams[0] = subStreams;
                liveStreams[i] = mainStreams;

                liveStreams[i].flvPlayer.pause();
                liveStreams[i].flvPlayer.destroy();
                liveStreams[i].flvPlayer = undefined;
                liveStreams[i].spanElement.innerHTML = '';

                liveStreams[0].flvPlayer.pause();
                liveStreams[0].flvPlayer.destroy();
                liveStreams[0].flvPlayer = undefined;
                liveStreams[0].spanElement.innerHTML = '';

                loadStreamsByList();
            }
            function loadStreamsByList(list) {
                if (streamClosed) return;
                if (list) liveStreams = list;
                for (let i = 0; i < 4; i++) {
                    let stream = liveStreams[i];
                    if (!stream) break;
                    if (stream.flvPlayer) continue;
                    let elementid = 'videoElement' + i;
                    let videoElement = document.getElementById(elementid);
                    let spanElement = document.getElementById('spanElement' + i);
                    let seed = stream.id.charCodeAt(0);
                    spanElement.innerHTML = titleList[(seed % (titleList.length))] + '-' + stream.StreamPath.slice(6);
                    let flvPlayer = flvjs.createPlayer({
                        type: 'flv',
                        isLive: true,
                        cors: true,
                        url: `ws://${host}:8000${stream.StreamPath}.flv`,
                    })

                    stream.flvPlayer = flvPlayer;
                    stream.spanElement = spanElement;

                    flvPlayer.attachMediaElement(videoElement);
                    if (i !== 0) {
                        flvPlayer.muted = true;
                        console.log(i, stream);
                    }
                    flvPlayer.load();
                    flvPlayer.play();
                }
            }
            function genDjList() {
                console.log('gened');
                const djListElement = document.getElementById('dj-list');
                djListElement.innerHTML = '';
                for (let i = 0; i < djStreams.length; i++) {
                    const stream = djStreams[i];
                    const spanElement = document.createElement('p');
                    spanElement.innerHTML = stream.StreamPath.slice(9);
                    if (i === 0) {
                        spanElement.style = 'color:red';
                    }
                    djListElement.appendChild(spanElement);
                }
            }
            function addStream(stream) {
                liveStreams.push(stream);
                loadStreamsByList();
            }
            function removeStream(id) {
                let index = liveStreams.findIndex((v) => {
                    return v.id === id;
                });
                if (index === -1) return;
                let stream = liveStreams[index];
                if (stream.flvPlayer) {
                    for (let i = 0; i < 4; i++) {
                        if (liveStreams[i] && liveStreams[i].flvPlayer && i >= index) {
                            liveStreams[i].flvPlayer.pause();
                            liveStreams[i].flvPlayer.destroy();
                            liveStreams[i].flvPlayer = undefined;
                            liveStreams[i].spanElement.innerHTML = '';
                        }
                    }
                    liveStreams.splice(index, 1);
                    loadStreamsByList();
                } else {
                    liveStreams.splice(index, 1);
                }
            }
            function loadDjStreamByList(djList) {
                genDjList();
                const audioElement = document.getElementById('audioElement');
                if (djList) djStreams = djList;
                let stream = djStreams[0];
                if (!stream) return;
                if (stream.flvPlayer) return;
                let flvPlayer = flvjs.createPlayer({
                    type: 'flv',
                    isLive: true,
                    cors: true,
                    url: `ws://${host}:8000${stream.StreamPath}.flv`,
                    hasVideo: false
                })
                flvPlayer.attachMediaElement(audioElement);
                flvPlayer.load();
                flvPlayer.play();
                if (liveStreams[0] && liveStreams[0].flvPlayer) liveStreams[0].flvPlayer.muted = true;
                stream.flvPlayer = flvPlayer;

                //刷新DJ列表
                genDjList();
            }
            function removeDjStream(id) {
                let i = djStreams.findIndex((v) => {
                    return v.id === id;
                });
                if (i === -1) return;
                let stream = djStreams[i];
                if (stream.flvPlayer) {
                    djStreams[i].flvPlayer.pause();
                    djStreams[i].flvPlayer.destroy();
                    djStreams[i].flvPlayer = undefined;
                    djStreams.splice(i, 1);
                    loadDjStreamByList();
                } else {
                    djStreams.splice(i, 1);
                    loadDjStreamByList();
                }
                if (djStreams.length === 0 && liveStreams[0]) liveStreams[0].flvPlayer.muted = false;
            }
            var socket = io();
            socket.on('liveStreams-list', (liveList, djList) => {
                loadStreamsByList(liveList);
                loadDjStreamByList(djList);
            })
            socket.on('post-publish', (stream) => {
                addStream(stream);
            })
            socket.on('done-publish', (id) => {
                removeStream(id);
                removeDjStream(id);
            })
            socket.on('dj-post-publish', (stream) => {
                djStreams.push(stream);
                loadDjStreamByList();
            });
            socket.emit('request-liveStreams');
        }
    </script>
</body>

</html>