<html>

<body>
    <script src="https://cdn.bootcss.com/flv.js/1.3.3/flv.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .main-container {
            height: 70%;
            display: flex;
            justify-content: center;
        }

        .sub-container {
            height: 30%;
            display: flex;
            flex-wrap: nowrap;
        }

        video {
            height: 100%;
        }
        .video-container{
            position: relative;
        }
        span {
            top: 10px;
            position: absolute;
            background:white;
            left:10px;
        }
    </style>
    <div class="main-container">
        <div class="video-container">
            <video id="videoElement0"></video>
            <span id="spanElement0"></span>
        </div>
    </div>
    <div style="background:gray" class="sub-container">
        <div class="video-container">
            <video id="videoElement1"></video>
            <span id="spanElement1"></span>
        </div>
        <div class="video-container">
            <video id="videoElement2"></video>
            <span id="spanElement2"></span>
        </div>
        <div class="video-container">
            <video id="videoElement3"></video>
            <span id="spanElement3"></span>
        </div>
    </div>

    <script>
        var host = 'localhost'
        if (flvjs.isSupported()) {
            /*
            var videoElement = document.getElementById('videoElement');
            var videoElement1 = document.getElementById('videoElement1');
            var flvPlayer = flvjs.createPlayer({
                type: 'flv',
                isLive: true,
                cors: true,
                url: `ws://${host}:8000/live/STREAM_NAME.flv`
            });
            flvPlayer.attachMediaElement(videoElement);
            flvPlayer.load();
            flvPlayer.play();
            flvPlayer.muted = true;
            */
            let liveStreams = [];
            function loadStreamsByList(list) {
                if (list) liveStreams = list;
                console.log(liveStreams);
                for (let i = 0; i < 3; i++) {
                    let stream = liveStreams[i];
                    if (!stream) break;
                    if (stream.flvPlayer) continue;
                    let elementid = 'videoElement' + i;
                    let videoElement = document.getElementById(elementid);
                    let spanElement = document.getElementById('spanElement'+i);
                    spanElement.innerHTML = stream.StreamPath.slice(6);
                    let flvPlayer = flvjs.createPlayer({
                        type: 'flv',
                        isLive: true,
                        cors: true,
                        url: `ws://${host}:8000${stream.StreamPath}.flv`
                    })
                    flvPlayer.attachMediaElement(videoElement);
                    flvPlayer.load();
                    flvPlayer.play();
                    if (i !== 0) flvPlayer.muted = true;
                    stream.flvPlayer = flvPlayer;
                    stream.spanElement = spanElement;
                }
            }
            function addStream(stream) {
                liveStreams.push(stream);
                loadStreamsByList();
            }
            function removeStream(id) {
                let i = liveStreams.findIndex((v) => {
                    return v.id === id;
                });
                if (i === -1) return;
                let stream = liveStreams[i];
                if (stream.flvPlayer) {
                    for (let i = 0; i < 4; i++) {
                        if (liveStreams[i] && liveStreams[i].flvPlayer) {
                            liveStreams[i].flvPlayer.pause();
                            liveStreams[i].flvPlayer.destroy();
                            liveStreams[i].flvPlayer = undefined;
                            liveStreams[i].spanElement.innerHTML = '';
                        }
                    }
                    liveStreams.splice(i, 1);
                    loadStreamsByList();
                } else {
                    liveStreams.splice(i, 1);
                }
            }
            var socket = io();
            socket.on('liveStreams-list', (list) => {
                loadStreamsByList(list);
            })
            socket.on('post-publish', (stream) => {
                addStream(stream);
            })
            socket.on('donw-publish', (id) => {
                removeStream(id);
            })
            socket.emit('request-liveStreams');
        }
    </script>
</body>

</html>